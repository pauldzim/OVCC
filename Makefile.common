ifeq ($(TARGETOS),Mingw)
EXEDIR = ..
LIBDIR = ../libs
else
prefix = /usr/local
EXEDIR = $(DESTDIR)$(prefix)/bin
LIBDIR = $(DESTDIR)$(prefix)/lib/ovcc
endif

ODIR = obj

DEBUG=#-g #-D _DEBUG
OPT=-Ofast -march=native -flto # -Og # -Ofast #
WARN = -w # -Wall
PTHREAD = -pthread
OPTIONS = #-D CUT_PASTE

ifeq ($(TARGETOS),Darwin)
CFLAGS += -D DARWIN
endif

SDLINC := $(shell pkg-config --cflags sdl2)
AGARINC := $(shell agar-config --cflags)
CLIPINC := -I ../clip
IDIR = $(INCDIR) $(SDLINC) $(AGARINC) $(CLIPINC)

SDLLIB := $(shell sdl2-config --libs)
AGARLIB := $(shell agar-config --libs)
CLIPLIB := -L ../clip -lclip
LIBS = $(SDLLIB) $(AGARLIB) $(CLIPLIB)

ifneq ($(TARGETOS),Darwin)
LIBS := $(LIBS) -lxcb -lrt
endif

CFLAGS += $(DEBUG) $(OPT) $(WARN) $(OPTIONS) $(IDIR)

LDFLAGS += $(LIBS) #-Wl,-export-all-symbols # -export-dynamic

OBJS = $(patsubst %,$(ODIR)/%,$(_OBJS))
CXXOBJS = $(patsubst %,$(ODIR)/%,$(_CXXOBJS))

$(TARGET): $(OBJS) $(CXXOBJS)
	$(CXX) -o $@ $(OPT) $^ $(LDFLAGS)

testlib: $(ODIR)/testlib.o
	$(CC) -o $@ $< $(LIBS)

$(ODIR)/testlib.o: ../testlib.c | $(ODIR)
	$(CC) -O0 -g -c $(SDLINC) $< -o $@

test: $(TARGET) testlib
	LD_LIBRARY_PATH=. ./testlib $(TARGET) ModuleName

$(ODIR):
	mkdir -p $@

$(OBJS): | $(ODIR)
$(CXXOBJS): | $(ODIR)

$(OBJS):
	$(CC) $(CFLAGS) -c $< -o $@

$(CXXOBJS):
	$(CXX) $(CFLAGS) $(CXXFLAGS) -c $< -o $@

install: $(TARGET)
	install -D --mode=0644 $(TARGET) $(LIBDIR)/$(TARGET)

clean:
	rm -f $(ODIR)/*.o $(TARGET) testlib
